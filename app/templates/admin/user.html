{% extends 'base/base_admin.html' %}
{% block title %}จัดการสมาชิก | Admin{% endblock %}
{% block content %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/admin_user.css') }}">

<div class="admin-users">
  <div class="container">

    <!-- Header -->
    <div class="page-header">
      <div class="page-title">จัดการสมาชิก</div>

      <form class="searchbar" method="get" action="{{ url_for('admin_users.index') }}">
        <input type="text" name="q" placeholder="รหัส/ชื่อ/อีเมล" value="{{ q or '' }}">
        <button type="submit" class="btn-search">ค้นหา</button>

        {% if q %}
          <a href="{{ url_for('admin_users.index') }}" class="btn-clear">
            <i class="ri-close-line"></i> ล้าง
          </a>
        {% endif %}
      </form>
    </div>

    <!-- Card -->
    <section class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th class="col-code">รหัส</th>
              <th class="col-name">ชื่อ</th>    
              <th class="col-role">บทบาท</th>
              <th class="col-role">ประเภทสมาชิก</th>
              <th>อีเมล</th>
              <th class="col-major">ภาควิชา</th>
              <th class="col-phone">เบอร์โทรศัพท์</th>
              <th class="col-actions">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% if users and users|length %}
              {% for u in users %}
              <tr>
                <td>{{ u.code or ('U' ~ u.user_id) }}</td>
                <td class="col-name">{{ u.name }}</td>

                <td>
                  {% set role = (u.role or 'member') %}
                  <span class="badge
                    {{ 'badge--admin' if role=='admin'
                       else 'badge--staff' if role=='staff'
                       else 'badge--student' if role=='student'
                       else 'badge--default' }}">
                    {{ role }}
                  </span>
                </td>

                <td>
                  {% set mtype = (u.member_type or '-') %}
                  <span class="badge
                    {{ 'badge--student' if mtype=='student'
                       else 'badge--teacher' if mtype=='teacher'
                       else 'badge--officer' if mtype=='officer'
                       else 'badge--default' }}">
                    {{ mtype }}
                  </span>
                </td>

                <td>{{ u.email }}</td>
                <td>{{ u.major or '-' }}</td>
                <td>{{ u.phone or '-' }}</td>

                <!-- Actions -->
                <td class="col-actions">
                  <a class="btn btn--sm btn-edit"
                     href="{{ url_for('admin_users.edit_user_page', user_id=u.user_id) }}">
                    แก้ไข
                  </a>

                  <button type="button"
                          class="btn btn--sm btn-warn"
                          onclick="openResetModal('{{ u.user_id }}', '{{ u.name }}')">
                    เปลี่ยนรหัสผ่าน
                  </button>

                  <a href="#"
                     class="btn btn--sm btn-delete"
                     onclick="return confirmDelete({{ u.user_id }});">
                    ลบ
                  </a>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr><td colspan="8" class="empty">ไม่พบข้อมูล</td></tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="table-footer">
        <div class="meta">
          แสดงหน้า {{ page or 1 }}/{{ total_pages or 1 }} (ทั้งหมด {{ total or 0 }} รายการ)
        </div>

        {% set base = request.path %}
        <nav class="pager">
          {% if page and total_pages and page > 1 %}
            <a href="{{ base }}?q={{ q or '' }}&page=1">« หน้าแรก</a>
            <a href="{{ base }}?q={{ q or '' }}&page={{ page-1 }}">ก่อนหน้า</a>
          {% else %}
            <span class="disabled">« หน้าแรก</span>
            <span class="disabled">ก่อนหน้า</span>
          {% endif %}

          <span class="current">หน้า {{ page or 1 }}</span>

          {% if page and total_pages and page < total_pages %}
            <a href="{{ base }}?q={{ q or '' }}&page={{ page+1 }}">ถัดไป</a>
            <a href="{{ base }}?q={{ q or '' }}&page={{ total_pages }}">หน้าสุดท้าย »</a>
          {% else %}
            <span class="disabled">ถัดไป</span>
            <span class="disabled">หน้าสุดท้าย »</span>
          {% endif %}
        </nav>
      </div>
    </section>
  </div>
</div>

<!-- ===== Modal: Reset Password ===== -->
<div class="modal" id="reset-modal" aria-hidden="true">
  <div class="modal__backdrop" data-close></div>

  <div class="modal__dialog">
    <header class="modal__header">
      <h3>รีเซ็ตรหัสผ่าน</h3>
      <button type="button" class="modal__close" data-close>&times;</button>
    </header>

    <div class="modal__body">
      <p>ตั้งรหัสผ่านใหม่: <strong id="modal-username"></strong></p>

      <form method="post"
            action="{{ url_for('admin_users.admin_set_password', user_id=0) }}"
            id="reset-form"
            class="set-password">
        <div class="form-group">
          <label>รหัสผ่านใหม่:</label>
          <input type="password" name="new_password" minlength="6" required placeholder="อย่างน้อย 6 ตัวอักษร">
        </div>

        <div class="form-group">
          <label>ยืนยันรหัสผ่าน:</label>
          <input type="password" name="confirm_password" minlength="6" required placeholder="พิมพ์ซ้ำอีกครั้ง">
        </div>

        <div class="modal__actions">
          <button type="button" class="btn btn-soft" id="btn-toggle-pw">แสดง/ซ่อน</button>
          <button type="submit" class="btn btn-danger">บันทึกรหัสผ่านใหม่</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ✅ Scripts -->
<script>
  // ===== Modal logic =====
  const modal = document.getElementById('reset-modal');
  const form = document.getElementById('reset-form');
  const nameEl = document.getElementById('modal-username');
  const closeEls = modal.querySelectorAll('[data-close]');

  function openResetModal(uid, uname) {
    nameEl.textContent = uname;
    form.action = "{{ url_for('admin_users.admin_set_password', user_id=0) }}".replace('0', uid);
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
  }

  function closeModal() {
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
  }

  closeEls.forEach(el => el.addEventListener('click', closeModal));
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal();
  });

  // ===== Password helpers =====
  function genRandomPassword(len = 12) {
    const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$%^&*?";
    let out = "";
    for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
    return out;
  }

  const btnGen = document.getElementById('btn-gen-pw');
  const btnToggle = document.getElementById('btn-toggle-pw');
  if (btnGen) {
    btnGen.addEventListener('click', () => {
      const pw1 = form.querySelector('[name=new_password]');
      const pw2 = form.querySelector('[name=confirm_password]');
      const rand = genRandomPassword(12);
      pw1.value = rand; pw2.value = rand;
    });
  }
  if (btnToggle) {
    btnToggle.addEventListener('click', () => {
      ['new_password', 'confirm_password'].forEach(name => {
        const el = form.querySelector(`[name=${name}]`);
        el.type = el.type === 'password' ? 'text' : 'password';
      });
    });
  }
</script>
{% endblock %}
